class d{constructor(){this.elements={btn:document.getElementById("ai-chatbot-btn"),window:document.getElementById("ai-chatbot-window"),form:document.getElementById("ai-chatbot-form"),input:document.getElementById("ai-chatbot-input"),messages:document.getElementById("ai-chatbot-messages"),clear:document.getElementById("ai-chatbot-clear"),close:document.getElementById("ai-chatbot-close")},this.state={isOpen:!1,isTyping:!1,messageCount:0},this.config={maxMessages:50,typingDuration:1e3,scrollDelay:100},this.init()}init(){if(!this.validateElements()){console.warn("Chatbot: Some elements not found, chatbot disabled");return}this.bindEvents(),this.addWelcomeMessage(),this.setupAccessibility()}validateElements(){return Object.values(this.elements).every(e=>e!==null)}bindEvents(){var e,t,s,n,a,o;(e=this.elements.btn)==null||e.addEventListener("click",()=>this.toggle()),(t=this.elements.close)==null||t.addEventListener("click",()=>this.closeWindow()),(s=this.elements.clear)==null||s.addEventListener("click",()=>this.clearChat()),(n=this.elements.form)==null||n.addEventListener("submit",i=>this.handleSubmit(i)),(a=this.elements.input)==null||a.addEventListener("keydown",i=>{var r;i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),(r=this.elements.form)==null||r.dispatchEvent(new Event("submit")))}),document.addEventListener("keydown",i=>{i.key==="Escape"&&this.state.isOpen&&this.closeWindow()}),(o=this.elements.input)==null||o.addEventListener("keypress",i=>{i.key==="Enter"&&this.state.isTyping&&i.preventDefault()})}setupAccessibility(){var e,t,s;(e=this.elements.btn)==null||e.setAttribute("aria-expanded","false"),(t=this.elements.window)==null||t.setAttribute("role","dialog"),(s=this.elements.window)==null||s.setAttribute("aria-label","AI Assistant Chat")}toggle(){var e,t;this.state.isOpen=!this.state.isOpen,this.elements.window.style.display=this.state.isOpen?"block":"none",(e=this.elements.btn)==null||e.setAttribute("aria-expanded",this.state.isOpen.toString()),this.state.isOpen&&((t=this.elements.input)==null||t.focus(),this.scrollToBottom(),this.addEntryAnimation())}closeWindow(){var e;this.state.isOpen=!1,this.elements.window.style.display="none",(e=this.elements.btn)==null||e.setAttribute("aria-expanded","false")}clearChat(){this.elements.messages&&(this.elements.messages.innerHTML="",this.state.messageCount=0,this.addWelcomeMessage())}addWelcomeMessage(){var t;const e=document.createElement("div");e.className="text-secondary text-center small",e.textContent="How can I help you today?",e.setAttribute("data-message-type","welcome"),(t=this.elements.messages)==null||t.appendChild(e)}async handleSubmit(e){var n;e.preventDefault();const t=(n=this.elements.input)==null?void 0:n.value.trim();if(!t||this.state.isTyping||this.state.messageCount>=this.config.maxMessages)return;this.addMessage("user",t),this.elements.input.value="";const s=this.addTypingIndicator();try{const a=await this.sendMessage(t);s==null||s.remove(),this.addMessage("ai",a)}catch(a){console.error("Chatbot error:",a),s==null||s.remove(),this.addMessage("ai","Sorry, I encountered an error. Please try again.")}}async sendMessage(e){var a;const t=(a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.getAttribute("content");if(!t)throw new Error("CSRF token not found");const s=await fetch("/chatbot",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":t,Accept:"application/json"},body:JSON.stringify({message:e})});if(!s.ok){const o=await s.text();throw new Error(`HTTP ${s.status}: ${o}`)}return(await s.json()).reply||"I apologize, but I couldn't generate a response."}addMessage(e,t){if(!this.elements.messages)return null;const s=document.createElement("div");s.className=`mb-3 ${e==="user"?"text-end":"text-start"}`,s.setAttribute("data-message-type",e);const n=document.createElement("div");return n.className=`d-inline-block p-2 rounded-3 ${e==="user"?"bg-primary text-white":"bg-secondary text-light"}`,n.style.maxWidth="80%",n.innerHTML=this.sanitizeContent(t),s.appendChild(n),this.elements.messages.appendChild(s),this.scrollToBottom(),this.state.messageCount++,s}sanitizeContent(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}addTypingIndicator(){var s;this.state.isTyping=!0;const e=document.createElement("div");e.className="mb-3 text-start",e.setAttribute("data-message-type","typing");const t=document.createElement("div");return t.className="d-inline-block p-2 rounded-3 bg-secondary text-light",t.style.maxWidth="80%",t.innerHTML='<div class="typing-indicator"><span></span><span></span><span></span></div>',e.appendChild(t),(s=this.elements.messages)==null||s.appendChild(e),this.scrollToBottom(),e}scrollToBottom(){setTimeout(()=>{this.elements.messages&&(this.elements.messages.scrollTop=this.elements.messages.scrollHeight)},this.config.scrollDelay)}addEntryAnimation(){var e;(e=this.elements.window)==null||e.classList.add("chatbot-enter"),setTimeout(()=>{var t;(t=this.elements.window)==null||t.classList.remove("chatbot-enter")},300)}}document.addEventListener("DOMContentLoaded",function(){try{new d}catch(l){console.error("Failed to initialize chatbot:",l)}});
